"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6837],{66123:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>t,default:()=>h,frontMatter:()=>r,metadata:()=>c,toc:()=>d});var i=s(85893),o=s(11151);const r={title:"Migrations",sidebar_label:"Migrations",sidebar_position:9,slug:"/ibc/light-clients/wasm/migrations"},t="Migrations",c={id:"light-clients/wasm/migrations",title:"Migrations",description:"This guide provides instructions for migrating 08-wasm versions.",source:"@site/docs/03-light-clients/04-wasm/09-migrations.md",sourceDirName:"03-light-clients/04-wasm",slug:"/ibc/light-clients/wasm/migrations",permalink:"/main/ibc/light-clients/wasm/migrations",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:9,frontMatter:{title:"Migrations",sidebar_label:"Migrations",sidebar_position:9,slug:"/ibc/light-clients/wasm/migrations"},sidebar:"defaultSidebar",previous:{title:"Client",permalink:"/main/ibc/light-clients/wasm/client"},next:{title:"Overview",permalink:"/main/middleware/ics29-fee/overview"}},a={},d=[{value:"From ibc-go v8.3.x to ibc-go v9.0.x",id:"from-ibc-go-v83x-to-ibc-go-v90x",level:2},{value:"Chains",id:"chains",level:3},{value:"From v0.2.0+ibc-go-v8.3-wasmvm-v2.0 to v0.3.0-ibc-go-v8.3-wasmvm-v2.0",id:"from-v020ibc-go-v83-wasmvm-v20-to-v030-ibc-go-v83-wasmvm-v20",level:2},{value:"Contract developers",id:"contract-developers",level:3},{value:"From v0.1.1+ibc-go-v7.3-wasmvm-v1.5 to v0.2.0-ibc-go-v7.3-wasmvm-v1.5",id:"from-v011ibc-go-v73-wasmvm-v15-to-v020-ibc-go-v73-wasmvm-v15",level:2},{value:"Contract developers",id:"contract-developers-1",level:3},{value:"From ibc-go v7.3.x to ibc-go v8.0.x",id:"from-ibc-go-v73x-to-ibc-go-v80x",level:2},{value:"Chains",id:"chains-1",level:3},{value:"From v0.1.0+ibc-go-v8.0-wasmvm-v1.5 to v0.2.0-ibc-go-v8.3-wasmvm-v2.0",id:"from-v010ibc-go-v80-wasmvm-v15-to-v020-ibc-go-v83-wasmvm-v20",level:2},{value:"Chains",id:"chains-2",level:3}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"migrations",children:"Migrations"}),"\n",(0,i.jsx)(n.p,{children:"This guide provides instructions for migrating 08-wasm versions."}),"\n",(0,i.jsx)(n.h2,{id:"from-ibc-go-v83x-to-ibc-go-v90x",children:"From ibc-go v8.3.x to ibc-go v9.0.x"}),"\n",(0,i.jsx)(n.h3,{id:"chains",children:"Chains"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"Initialize"}),", ",(0,i.jsx)(n.code,{children:"Status"}),", ",(0,i.jsx)(n.code,{children:"GetTimestampAtHeight"}),", ",(0,i.jsx)(n.code,{children:"GetLatestHeight"}),", ",(0,i.jsx)(n.code,{children:"VerifyMembership"}),", ",(0,i.jsx)(n.code,{children:"VerifyNonMembership"}),", ",(0,i.jsx)(n.code,{children:"VerifyClientMessage"}),", ",(0,i.jsx)(n.code,{children:"UpdateState"})," and ",(0,i.jsx)(n.code,{children:"UpdateStateOnMisbehaviour"})," functions in ",(0,i.jsx)(n.code,{children:"ClientState"})," have been removed and all their logic has been moved to functions of the ",(0,i.jsx)(n.code,{children:"LightClientModule"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"MigrateContract"})," function has been removed from ",(0,i.jsx)(n.code,{children:"ClientState"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"VerifyMembershipMsg"})," and ",(0,i.jsx)(n.code,{children:"VerifyNonMembershipMsg"})," payloads for ",(0,i.jsx)(n.code,{children:"SudoMsg"})," have been modified. The ",(0,i.jsx)(n.code,{children:"Path"})," field of both structs has been updated from ",(0,i.jsx)(n.code,{children:"v1.MerklePath"})," to ",(0,i.jsx)(n.code,{children:"v2.MerklePath"}),". The new ",(0,i.jsx)(n.code,{children:"v2.MerklePath"})," field contains a ",(0,i.jsx)(n.code,{children:"KeyPath"})," of ",(0,i.jsx)(n.code,{children:"[][]byte"})," as opposed to ",(0,i.jsx)(n.code,{children:"[]string"}),", see ",(0,i.jsx)(n.a,{href:"/main/migrations/v8-to-v9#23-commitment",children:"23-commitment"}),". This supports proving values stored under keys which contain non-utf8 encoded symbols. As a result, the JSON field ",(0,i.jsx)(n.code,{children:"path"})," containing ",(0,i.jsx)(n.code,{children:"key_path"})," of both messages will marshal elements as a base64 encoded bytestrings. This is a breaking change for 08-wasm client contracts and they should be migrated to correctly support deserialisation of the ",(0,i.jsx)(n.code,{children:"v2.MerklePath"})," field."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"ExportMetadataMsg"})," struct has been removed and is no longer required for contracts to implement. Core IBC will handle exporting all key/value's written to the store by a light client contract."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"ZeroCustomFields"})," interface function has been removed from the ",(0,i.jsx)(n.code,{children:"ClientState"})," interface. Core IBC only used this function to set tendermint client states when scheduling an IBC software upgrade. The interface function has been replaced by a type assertion."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"MaxWasmByteSize"})," function has been removed in favor of the ",(0,i.jsx)(n.code,{children:"MaxWasmSize"})," constant."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"HasChecksum"}),", ",(0,i.jsx)(n.code,{children:"GetAllChecksums"})," and ",(0,i.jsx)(n.code,{children:"Logger"})," functions have been moved from the ",(0,i.jsx)(n.code,{children:"types"})," package to a method on the ",(0,i.jsx)(n.code,{children:"Keeper"})," type in the ",(0,i.jsx)(n.code,{children:"keeper"})," package."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"InitializePinnedCodes"})," function has been moved to a method on the ",(0,i.jsx)(n.code,{children:"Keeper"})," type in the ",(0,i.jsx)(n.code,{children:"keeper"})," package."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"CustomQuerier"}),", ",(0,i.jsx)(n.code,{children:"StargateQuerier"})," and ",(0,i.jsx)(n.code,{children:"QueryPlugins"})," types have been moved from the ",(0,i.jsx)(n.code,{children:"types"})," package to the ",(0,i.jsx)(n.code,{children:"keeper"})," package."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"NewDefaultQueryPlugins"}),", ",(0,i.jsx)(n.code,{children:"AcceptListStargateQuerier"})," and ",(0,i.jsx)(n.code,{children:"RejectCustomQuerier"})," functions has been moved from the ",(0,i.jsx)(n.code,{children:"types"})," package to the ",(0,i.jsx)(n.code,{children:"keeper"})," package."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"NewDefaultQueryPlugins"})," function signature has changed to take an argument: ",(0,i.jsx)(n.code,{children:"queryRouter ibcwasm.QueryRouter"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"AcceptListStargateQuerier"})," function signature has changed to take an additional argument: ",(0,i.jsx)(n.code,{children:"queryRouter ibcwasm.QueryRouter"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"WithQueryPlugins"})," function signature has changed to take in the ",(0,i.jsx)(n.code,{children:"QueryPlugins"})," type from the ",(0,i.jsx)(n.code,{children:"keeper"})," package (previously from the ",(0,i.jsx)(n.code,{children:"types"})," package)."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"VMGasRegister"})," variable has been moved from the ",(0,i.jsx)(n.code,{children:"types"})," package to the ",(0,i.jsx)(n.code,{children:"keeper"})," package."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"from-v020ibc-go-v83-wasmvm-v20-to-v030-ibc-go-v83-wasmvm-v20",children:"From v0.2.0+ibc-go-v8.3-wasmvm-v2.0 to v0.3.0-ibc-go-v8.3-wasmvm-v2.0"}),"\n",(0,i.jsx)(n.h3,{id:"contract-developers",children:"Contract developers"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"v0.3.0"})," release of 08-wasm for ibc-go ",(0,i.jsx)(n.code,{children:"v8.3.x"})," and above introduces a breaking change for client contract developers."]}),"\n",(0,i.jsxs)(n.p,{children:["The contract API ",(0,i.jsx)(n.code,{children:"SudoMsg"})," payloads ",(0,i.jsx)(n.code,{children:"VerifyMembershipMsg"})," and ",(0,i.jsx)(n.code,{children:"VerifyNonMembershipMsg"})," have been modified.\nThe encoding of the ",(0,i.jsx)(n.code,{children:"Path"})," field of both structs has been updated from ",(0,i.jsx)(n.code,{children:"v1.MerklePath"})," to ",(0,i.jsx)(n.code,{children:"v2.MerklePath"})," to support proving values stored under keys which contain non-utf8 encoded symbols."]}),"\n",(0,i.jsxs)(n.p,{children:["As a result, the ",(0,i.jsx)(n.code,{children:"Path"})," field now contains a ",(0,i.jsx)(n.code,{children:"MerklePath"})," composed of ",(0,i.jsx)(n.code,{children:"key_path"})," of ",(0,i.jsx)(n.code,{children:"[][]byte"})," as opposed to ",(0,i.jsx)(n.code,{children:"[]string"}),". The JSON field ",(0,i.jsx)(n.code,{children:"path"})," containing ",(0,i.jsx)(n.code,{children:"key_path"})," of both ",(0,i.jsx)(n.code,{children:"VerifyMembershipMsg"})," and ",(0,i.jsx)(n.code,{children:"VerifyNonMembershipMsg"})," structs will now marshal elements as base64 encoded bytestrings. See below for example JSON diff."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-diff",children:'{\n  "verify_membership": {\n    "height": {\n      "revision_height": 1\n    },\n    "delay_time_period": 0,\n    "delay_block_period": 0,\n    "proof":"dmFsaWQgcHJvb2Y=",\n    "path": {\n+      "key_path":["L2liYw==","L2tleS9wYXRo"]\n-      "key_path":["/ibc","/key/path"]\n    },\n    "value":"dmFsdWU="\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["A migration is required for existing 08-wasm client contracts in order to correctly handle the deserialisation of ",(0,i.jsx)(n.code,{children:"key_path"})," from ",(0,i.jsx)(n.code,{children:"[]string"})," to ",(0,i.jsx)(n.code,{children:"[][]byte"}),".\nContract developers should familiarise themselves with the migration path offered by 08-wasm ",(0,i.jsx)(n.a,{href:"/main/ibc/light-clients/wasm/governance#migrating-an-existing-wasm-light-client-contract",children:"here"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"An example of the required changes in a client contract may look like:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-diff",children:"#[cw_serde]\npub struct MerklePath {\n+   pub key_path: Vec<cosmwasm_std::Binary>,\n-   pub key_path: Vec<String>,\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Please refer to the ",(0,i.jsx)(n.a,{href:"https://docs.rs/cosmwasm-std/2.0.4/cosmwasm_std/struct.Binary.html",children:(0,i.jsx)(n.code,{children:"cosmwasm_std"})})," documentation for more information."]}),"\n",(0,i.jsx)(n.h2,{id:"from-v011ibc-go-v73-wasmvm-v15-to-v020-ibc-go-v73-wasmvm-v15",children:"From v0.1.1+ibc-go-v7.3-wasmvm-v1.5 to v0.2.0-ibc-go-v7.3-wasmvm-v1.5"}),"\n",(0,i.jsx)(n.h3,{id:"contract-developers-1",children:"Contract developers"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"v0.2.0"})," release of 08-wasm for ibc-go ",(0,i.jsx)(n.code,{children:"v7.6.x"})," and above introduces a breaking change for client contract developers."]}),"\n",(0,i.jsxs)(n.p,{children:["The contract API ",(0,i.jsx)(n.code,{children:"SudoMsg"})," payloads ",(0,i.jsx)(n.code,{children:"VerifyMembershipMsg"})," and ",(0,i.jsx)(n.code,{children:"VerifyNonMembershipMsg"})," have been modified.\nThe encoding of the ",(0,i.jsx)(n.code,{children:"Path"})," field of both structs has been updated from ",(0,i.jsx)(n.code,{children:"v1.MerklePath"})," to ",(0,i.jsx)(n.code,{children:"v2.MerklePath"})," to support proving values stored under keys which contain non-utf8 encoded symbols."]}),"\n",(0,i.jsxs)(n.p,{children:["As a result, the ",(0,i.jsx)(n.code,{children:"Path"})," field now contains a ",(0,i.jsx)(n.code,{children:"MerklePath"})," composed of ",(0,i.jsx)(n.code,{children:"key_path"})," of ",(0,i.jsx)(n.code,{children:"[][]byte"})," as opposed to ",(0,i.jsx)(n.code,{children:"[]string"}),". The JSON field ",(0,i.jsx)(n.code,{children:"path"})," containing ",(0,i.jsx)(n.code,{children:"key_path"})," of both ",(0,i.jsx)(n.code,{children:"VerifyMembershipMsg"})," and ",(0,i.jsx)(n.code,{children:"VerifyNonMembershipMsg"})," structs will now marshal elements as base64 encoded bytestrings. See below for example JSON diff."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-diff",children:'{\n  "verify_membership": {\n    "height": {\n      "revision_height": 1\n    },\n    "delay_time_period": 0,\n    "delay_block_period": 0,\n    "proof":"dmFsaWQgcHJvb2Y=",\n    "path": {\n+      "key_path":["L2liYw==","L2tleS9wYXRo"]\n-      "key_path":["/ibc","/key/path"]\n    },\n    "value":"dmFsdWU="\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["A migration is required for existing 08-wasm client contracts in order to correctly handle the deserialisation of ",(0,i.jsx)(n.code,{children:"key_path"})," from ",(0,i.jsx)(n.code,{children:"[]string"})," to ",(0,i.jsx)(n.code,{children:"[][]byte"}),".\nContract developers should familiarise themselves with the migration path offered by 08-wasm ",(0,i.jsx)(n.a,{href:"/main/ibc/light-clients/wasm/governance#migrating-an-existing-wasm-light-client-contract",children:"here"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"An example of the required changes in a client contract may look like:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-diff",children:"#[cw_serde]\npub struct MerklePath {\n+   pub key_path: Vec<cosmwasm_std::Binary>,\n-   pub key_path: Vec<String>,\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Please refer to the ",(0,i.jsx)(n.a,{href:"https://docs.rs/cosmwasm-std/2.0.4/cosmwasm_std/struct.Binary.html",children:(0,i.jsx)(n.code,{children:"cosmwasm_std"})})," documentation for more information."]}),"\n",(0,i.jsx)(n.h2,{id:"from-ibc-go-v73x-to-ibc-go-v80x",children:"From ibc-go v7.3.x to ibc-go v8.0.x"}),"\n",(0,i.jsx)(n.h3,{id:"chains-1",children:"Chains"}),"\n",(0,i.jsxs)(n.p,{children:["In the 08-wasm versions compatible with ibc-go v7.3.x and above from the v7 release line, the checksums of the uploaded Wasm bytecodes are all stored under a single key. From ibc-go v8.0.x the checksums are stored using ",(0,i.jsx)(n.a,{href:"https://docs.cosmos.network/v0.50/build/packages/collections#keyset",children:(0,i.jsx)(n.code,{children:"collections.KeySet"})}),", whose full functionality became available in Cosmos SDK v0.50. There is therefore an ",(0,i.jsx)(n.a,{href:"https://github.com/cosmos/ibc-go/blob/57fcdb9a9a9db9b206f7df2f955866dc4e10fef4/modules/light-clients/08-wasm/module.go#L115-L118",children:"automatic migration handler"})," configured in the 08-wasm module to migrate the stored checksums to ",(0,i.jsx)(n.code,{children:"collections.KeySet"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"from-v010ibc-go-v80-wasmvm-v15-to-v020-ibc-go-v83-wasmvm-v20",children:"From v0.1.0+ibc-go-v8.0-wasmvm-v1.5 to v0.2.0-ibc-go-v8.3-wasmvm-v2.0"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"WasmEngine"})," interface has been updated to reflect changes in the function signatures of Wasm VM:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-diff",children:"type WasmEngine interface {\n- StoreCode(code wasmvm.WasmCode) (wasmvm.Checksum, error)\n+ StoreCode(code wasmvm.WasmCode, gasLimit uint64) (wasmvmtypes.Checksum, uint64, error)\n\n  StoreCodeUnchecked(code wasmvm.WasmCode) (wasmvm.Checksum, error)\n\n  Instantiate(\n    checksum wasmvm.Checksum,\n    env wasmvmtypes.Env,\n    info wasmvmtypes.MessageInfo,\n    initMsg []byte,\n    store wasmvm.KVStore,\n    goapi wasmvm.GoAPI,\n    querier wasmvm.Querier,\n    gasMeter wasmvm.GasMeter,\n    gasLimit uint64,\n    deserCost wasmvmtypes.UFraction,\n- ) (*wasmvmtypes.Response, uint64, error)\n+ ) (*wasmvmtypes.ContractResult, uint64, error)\n\n  Query(\n    checksum wasmvm.Checksum,\n    env wasmvmtypes.Env,\n    queryMsg []byte,\n    store wasmvm.KVStore,\n    goapi wasmvm.GoAPI,\n    querier wasmvm.Querier,\n    gasMeter wasmvm.GasMeter,\n    gasLimit uint64,\n    deserCost wasmvmtypes.UFraction,\n- ) ([]byte, uint64, error)\n+ ) (*wasmvmtypes.QueryResult, uint64, error)\n\n  Migrate(\n    checksum wasmvm.Checksum,\n    env wasmvmtypes.Env,\n    migrateMsg []byte,\n    store wasmvm.KVStore,\n    goapi wasmvm.GoAPI,\n    querier wasmvm.Querier,\n    gasMeter wasmvm.GasMeter,\n    gasLimit uint64,\n    deserCost wasmvmtypes.UFraction,\n- ) (*wasmvmtypes.Response, uint64, error)\n+ ) (*wasmvmtypes.ContractResult, uint64, error)\n\n  Sudo(\n    checksum wasmvm.Checksum,\n    env wasmvmtypes.Env,\n    sudoMsg []byte,\n    store wasmvm.KVStore,\n    goapi wasmvm.GoAPI,\n    querier wasmvm.Querier,\n    gasMeter wasmvm.GasMeter,\n    gasLimit uint64,\n    deserCost wasmvmtypes.UFraction,\n- ) (*wasmvmtypes.Response, uint64, error)\n+ ) (*wasmvmtypes.ContractResult, uint64, error)\n\n  GetCode(checksum wasmvm.Checksum) (wasmvm.WasmCode, error)\n\n  Pin(checksum wasmvm.Checksum) error\n\n  Unpin(checksum wasmvm.Checksum) error\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Similar changes were required in the functions of ",(0,i.jsx)(n.code,{children:"MockWasmEngine"})," interface."]}),"\n",(0,i.jsx)(n.h3,{id:"chains-2",children:"Chains"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"SupportedCapabilities"})," field of ",(0,i.jsx)(n.code,{children:"WasmConfig"})," is now of type ",(0,i.jsx)(n.code,{children:"[]string"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-diff",children:"type WasmConfig struct {\n  DataDir string\n- SupportedCapabilities string\n+ SupportedCapabilities []string\n  ContractDebugMode bool\n}\n"})})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},11151:(e,n,s)=>{s.d(n,{Z:()=>c,a:()=>t});var i=s(67294);const o={},r=i.createContext(o);function t(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:t(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);